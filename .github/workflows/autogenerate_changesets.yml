name: Generate Changesets from Merged JS Files

on:
  pull_request:
    paths:
      - db_queries/**
    types:
      - closed # Trigger only when PR is closed (and potentially merged)

jobs:
  generate-changesets:
    if: ${{ github.event.pull_request.merged == true }} # Ensure only merged PRs trigger the workflow
    name: Generate Changesets Automatically
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout Repository
      - name: Checkout Repository
        uses: actions/checkout@v3

      # Step 2: Detect Merged .js File
      - name: Get Merged File Name
        id: get_filename
        run: |
          echo "Detecting merged .js file"
          git fetch --no-tags --depth=1 origin ${{ github.event.pull_request.base.ref }}
          MERGE_COMMIT_SHA=${{ github.event.pull_request.merge_commit_sha }}
          echo "Merge commit SHA: $MERGE_COMMIT_SHA"
          FILE=$(git diff-tree --no-commit-id --name-only -r $MERGE_COMMIT_SHA | grep 'db_queries/.*\.js')
          echo "File detected: $FILE"
          echo "js_file=$FILE" >> $GITHUB_ENV

      # Step 3: Set Up Python Environment
      - name: Install Python Dependencies
        run: |
          sudo apt update
          sudo apt install python3 python3-pip -y
          pip3 install PyGithub

      # Step 4: Run Python Script
      - name: Run Changeset Generator
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 scripts/v4.py --version $(basename ${{ env.js_file }} .js) --js_file ${{ env.js_file }} --author ${{ github.actor }} --repo "${{ github.repository }}" --branch "auto_changeset_${{ github.sha }}" --token "${{ secrets.GITHUB_TOKEN }}"

      # Step 5: Create Pull Request for XML Files
      - name: Create Pull Request for XML Files
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: "Auto-generated changeset for ${{ env.js_file }}"
          branch: auto_changeset-${{ github.sha }}
          title: "[Auto-Generated] XML Changeset for ${{ env.js_file }}"
          body: |
            - Generated XML file based on ${{ env.js_file }}
            - Review and update as needed.
