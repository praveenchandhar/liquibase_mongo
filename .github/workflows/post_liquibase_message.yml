name: Post Liquibase Usage Guide on PR Merge

on:
  pull_request:
    types:
      - closed # Trigger the workflow when a PR is closed

jobs:
  post-liquibase-guide:
    if: ${{ github.event.pull_request.merged == true }} # Run only if the PR was merged
    runs-on: ubuntu-latest

    steps:
      - name: Post Liquibase Usage Guide
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # GitHub Auth Token
        run: |
          # Define the Liquibase usage message
          MESSAGE=$(cat <<EOF
🌟🚀 **Liquibase Usage Guide** 🌟

Hello there! 👋 **Ready to rock some database changes using Liquibase?**

Here's how you can execute Liquibase commands from your **PR comments**:

---

### ⚡ **Available Liquibase Commands:**
✅ \`/liquibase status <db1>, <db2>\` - Check the status of changesets for the specified databases.  
✅ \`/liquibase update <db1>, <db2>\` - Apply pending changesets for the specified databases.  
✅ \`/liquibase\` - Display this detailed guide 🎉.

---

### 🛠️ **How to Use Liquibase Commands 🚀**

**1️⃣ Check the status of changesets:**  
Type the following in your PR comment:  
\`\`\`
/liquibase status liquibase_test, sample_mflix
\`\`\`  
**Description**: This will display the status of applied and pending changesets for the specified databases.

**2️⃣ Apply changesets:**  
Type the following in your PR comment:  
\`\`\`
/liquibase update liquibase_test, sample_mflix
\`\`\`  
**Description**: This will apply any pending changesets to the specified databases.

---

### 👩‍🔧 **Troubleshooting Tips:** 💡  
💡 Ensure jar files are available in the \`liquibase-jars\` directory.  
💡 Verify database connection strings and credentials.  
💡 Check your `changelog.xml` for proper syntax and context-specific filters.

---

🎉 **Keep rocking database updates!** 🚀  
EOF
          )

          # Post the message to the PR using GitHub's Issues API
          curl -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"body": "'"${MESSAGE}"'"}' \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments
