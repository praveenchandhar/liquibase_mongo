name: Post Liquibase Usage Guide on PR Merge

on:
  pull_request:
    types:
      - closed # Trigger the workflow when a PR is closed

jobs:
  post-liquibase-guide:
    if: ${{ github.event.pull_request.merged == true }} # Run only if the PR was merged
    runs-on: ubuntu-latest

    steps:
      - name: Post Liquibase Usage Guide
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # GitHub Auth Token
        run: |
          # Define the Liquibase usage message
          MESSAGE=$(cat <<EOF
ğŸŒŸğŸš€ **Liquibase Usage Guide** ğŸŒŸ

Hello there! ğŸ‘‹ **Ready to rock some database changes using Liquibase?**

Here's how you can execute Liquibase commands from your **PR comments**:

---

### âš¡ **Available Liquibase Commands:**
âœ… \`/liquibase status <db1>, <db2>\` - Check the status of changesets for the specified databases.  
âœ… \`/liquibase update <db1>, <db2>\` - Apply pending changesets for the specified databases.  
âœ… \`/liquibase\` - Display this detailed guide ğŸ‰.

---

### ğŸ› ï¸ **How to Use Liquibase Commands ğŸš€**

**1ï¸âƒ£ Check the status of changesets:**  
Type the following in your PR comment:  
\`\`\`
/liquibase status liquibase_test, sample_mflix
\`\`\`  
**Description**: This will display the status of applied and pending changesets for the specified databases.

**2ï¸âƒ£ Apply changesets:**  
Type the following in your PR comment:  
\`\`\`
/liquibase update liquibase_test, sample_mflix
\`\`\`  
**Description**: This will apply any pending changesets to the specified databases.

---

### ğŸ‘©â€ğŸ”§ **Troubleshooting Tips:** ğŸ’¡  
ğŸ’¡ Ensure jar files are available in the \`liquibase-jars\` directory.  
ğŸ’¡ Verify database connection strings and credentials.  
ğŸ’¡ Check your `changelog.xml` for proper syntax and context-specific filters.

---

ğŸ‰ **Keep rocking database updates!** ğŸš€  
EOF
          )

          # Post the message to the PR using GitHub's Issues API
          curl -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"body": "'"${MESSAGE}"'"}' \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments
